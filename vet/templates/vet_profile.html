{% extends "base.html" %}
{% load search_extras %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
  .profile-section-title {
    color: #2f6d5f !important; /* verde más oscuro para mejor contraste */
  }
</style>

<div class="container mt-4">
  <h1 class="h4 mb-3">Perfil del Veterinario</h1>

  <div class="card shadow-sm">
    <div class="card-body">
      <h2 class="h5">{{ vet.username }}</h2>
      <p><strong>Nombre:</strong> {{ vet.first_name }} {{ vet.last_name }}</p>
      <p><strong>Nombre profesional:</strong> {{ vet.nombre_profesional|default:"No especificado" }}</p>
      <p><strong>Correo:</strong> {{ vet.email|default:"No especificado" }}</p>
      <p><strong>Teléfono:</strong> {{ vet.telefono|default:"No especificado" }}</p>
      <p><strong>Dirección:</strong> {{ vet.direccion|default:"No especificado" }}</p>
      <p><strong>Especialización:</strong> {{ vet.especializacion|default:"No especificado" }}</p>

      <div class="mt-3">
        <h5 class="profile-section-title mb-2">Calificaciones</h5>
        {% if vet.promedio_puntuacion %}
          <p class="mb-1">
            <strong>Calificación promedio:</strong>
            {{ vet.promedio_puntuacion|floatformat:1 }} / 5
            <span class="text-muted">(basado en {{ vet.cantidad_valoraciones }} opiniones)</span>
          </p>
          <div class="fs-4 text-warning">{{ vet.promedio_puntuacion|star_rating }}</div>
        {% else %}
          <p class="text-muted mb-0">Aún no hay calificaciones para este profesional.</p>
        {% endif %}
      </div>
      
      {% if vet.certificado %}
        <p class="mt-3"><strong>Certificado:</strong> <a href="{{ vet.certificado.url }}" target="_blank">Ver documento</a></p>
      {% endif %}
      {% if vet.recibir_emergencias %}
        <p>
          <strong>Emergencias:</strong>
          <a href="tel:{{ vet.telefono }}" title="Llamar ahora">
            <i class="bi bi-telephone-fill" style="font-size: 1.5rem; color: green;"></i>
          </a>
        </p>
      {% endif %}

      <hr class="my-4">
      <!-- Información profesional ampliada -->
      <h5 class="profile-section-title">Información profesional</h5>
      <p><strong>Tipo de profesional:</strong> {{ vet.tipo_profesional|default:"No especificado" }}</p>
      <p><strong>Número de licencia:</strong> {{ vet.numero_licencia|default:"No especificado" }}</p>
      <p>
        <strong>Años de experiencia:</strong>
        {% if vet.anios_experiencia is not None %}
          {{ vet.anios_experiencia }} años
        {% else %}
          <span class="text-muted">No especificado</span>
        {% endif %}
      </p>

      <hr class="my-4">
      <h5 class="profile-section-title">Formación académica</h5>
      {% if vet.formacion_academica %}
        <p>{{ vet.formacion_academica|linebreaksbr }}</p>
      {% else %}
        <p><span class="text-muted">No especificado</span></p>
      {% endif %}

      <hr class="my-4">
      <h5 class="profile-section-title">Áreas de interés y servicios</h5>
      <p><strong>Especialidades adicionales:</strong>
        {% if vet.especialidades_adicionales %}
          {{ vet.especialidades_adicionales|linebreaksbr }}
        {% else %}
          <span class="text-muted">No especificado</span>
        {% endif %}
      </p>
      <p><strong>Servicios destacados:</strong>
        {% if vet.servicios_destacados %}
          {{ vet.servicios_destacados|linebreaksbr }}
        {% else %}
          <span class="text-muted">No especificado</span>
        {% endif %}
      </p>

      <hr class="my-4">
      <h5 class="profile-section-title">Otros datos</h5>
      <p><strong>Idiomas:</strong> {{ vet.idiomas|default:"No especificado" }}</p>
      <p><strong>Modalidad de atención:</strong> {{ vet.modalidad_atencion|default:"No especificado" }}</p>
      {% if vet.horario_atencion %}
        <p><strong>Horario de atención:</strong> {{ vet.horario_atencion|linebreaksbr }}</p>
      {% else %}
        <p><strong>Horario de atención:</strong> <span class="text-muted">No especificado</span></p>
      {% endif %}

      <hr class="my-4" id="seccion-calificacion">
      <h5 class="profile-section-title">Califica a este veterinario</h5>
      {% if request.user.is_authenticated %}
        {% if puede_calificar and valoracion_form %}
          {% if usuario_ya_valoro %}
            <div class="alert alert-info py-2 px-3 small">
              Ya has calificado a este profesional. Puedes actualizar tu calificación a continuación.
            </div>
          {% endif %}
          <form action="{% url 'valorar_veterinario' vet.id %}#seccion-calificacion" method="post" class="mt-3">
            {% csrf_token %}
            {% if valoracion_form.non_field_errors %}
              <div class="alert alert-danger">
                {% for error in valoracion_form.non_field_errors %}
                  <div>{{ error }}</div>
                {% endfor %}
              </div>
            {% endif %}
            <div class="mb-3">
              {{ valoracion_form.puntuacion.label_tag }}
              {{ valoracion_form.puntuacion }}
              <small class="form-text text-muted">{{ valoracion_form.puntuacion.help_text }}</small>
              {% if valoracion_form.puntuacion.errors %}
                <div class="text-danger small">
                  {% for error in valoracion_form.puntuacion.errors %}
                    <div>{{ error }}</div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            <div class="mb-3">
              {{ valoracion_form.comentario.label_tag }}
              {{ valoracion_form.comentario }}
              {% if valoracion_form.comentario.errors %}
                <div class="text-danger small">
                  {% for error in valoracion_form.comentario.errors %}
                    <div>{{ error }}</div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            <button type="submit" class="btn btn-primary">Enviar calificación</button>
          </form>
        {% else %}
          <div class="alert alert-secondary small mt-3">
            Este es tu perfil profesional, por lo que no puedes calificarlo.
          </div>
        {% endif %}
      {% else %}
        <p class="mt-3">
          <a href="{% url 'login' %}?next={% url 'vet_detail' vet.id %}" class="btn btn-outline-primary btn-sm">
            Inicia sesión para calificar a este veterinario
          </a>
        </p>
      {% endif %}

      <div class="mt-4">
        <h5 class="profile-section-title">Opiniones recientes</h5>
        {% if valoraciones_recientes %}
          {% for valoracion in valoraciones_recientes %}
            <div class="border rounded p-3 mb-2">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-warning">{{ valoracion.puntuacion|star_rating }}</span>
                <small class="text-muted">{{ valoracion.fecha_creacion|date:"d/m/Y H:i" }}</small>
              </div>
              <p class="mb-1">{{ valoracion.comentario|default:"Sin comentario" }}</p>
              <small class="text-muted">Por {{ valoracion.usuario.get_full_name|default:valoracion.usuario.username }}</small>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">Todavía no hay opiniones para mostrar.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
