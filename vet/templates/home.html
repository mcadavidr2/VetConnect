{% extends "base.html" %}
{% block content %}

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Veterinarios Cercanos</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    .card{border-radius:16px}
    .distance{font-size:.9rem}
  </style>
</head>
<body class="bg-body">



  <main class="container py-4">
    <h1 class="h3 mb-1">Veterinarios Cercanos</h1>
    <p class="text-secondary">Descubre clÃ­nicas cerca de tu ubicaciÃ³n.</p>

    <div class="d-flex gap-2 align-items-center mb-3">
      <button id="btnUbicacion" class="btn btn-primary">Usar mi ubicaciÃ³n</button>
       <a href="{% url 'veterinarios_cercanos' %}" class="btn btn-outline-primary">Ver listado completo</a>
      <div id="estado" class="small text-secondary"></div>
    </div>

    <div id="spinner" class="d-none text-center py-4">
      <div class="spinner-border" role="status"></div>
      <div class="small mt-2">Calculando distanciasâ€¦</div>
    </div>

    <div id="lista" class="row g-3"></div>
  </main>

  <script>
    const ENDPOINT = "{% url 'veterinarios_cercanos' %}";
    const lista = document.getElementById('lista');
    const estado = document.getElementById('estado');
    const spinner = document.getElementById('spinner');
    const btn = document.getElementById('btnUbicacion');

    function getCookie(name){
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if(parts.length === 2) return parts.pop().split(';').shift();
    }

    function pintar(vets){
      lista.innerHTML = '';
      if(!vets.length){
        lista.innerHTML = '<div class="col-12"><div class="alert alert-warning">No se encontraron veterinarios.</div></div>';
        return;
      }
      // Ordenados por distancia si viene en el JSON
      vets.forEach(v=>{
        const col = document.createElement('div');
        col.className = 'col-12 col-md-6 col-lg-4';
        col.innerHTML = `
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <h2 class="h5 mb-2">${v.nombre}</h2>
              <p class="mb-1">${v.direccion}</p>
              <p class="mb-1">ðŸ“ž ${v.telefono}</p>
              <a class="small" href="mailto:${v.email}">${v.email}</a>
              ${v.distancia !== undefined ? `<div class="text-secondary distance mt-2">â‰ˆ ${v.distancia.toFixed(2)} km</div>` : ''}
            </div>
          </div>`;
        lista.appendChild(col);
      });
    }

    function consultar(lat, lon){
      spinner.classList.remove('d-none');
      estado.textContent = '';
      fetch(ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ latitud: lat, longitud: lon })
      })
      .then(r => r.ok ? r.json() : Promise.reject(r))
      .then(data => { pintar(data); })
      .catch(()=> { estado.textContent = 'No se pudo obtener la lista.'; })
      .finally(()=> spinner.classList.add('d-none'));
    }

    btn.addEventListener('click', ()=>{
      if(!navigator.geolocation){
        estado.textContent = 'Tu navegador no soporta geolocalizaciÃ³n.';
        return;
      }
      estado.textContent = 'Obteniendo ubicaciÃ³nâ€¦';
      navigator.geolocation.getCurrentPosition(
        pos => {
          estado.textContent = 'Ordenando por cercanÃ­aâ€¦';
          consultar(pos.coords.latitude, pos.coords.longitude);
        },
        () => { estado.textContent = 'UbicaciÃ³n denegada. Muestra el listado completo en el enlace de arriba.'; }
      );
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>
 {% endblock %}
